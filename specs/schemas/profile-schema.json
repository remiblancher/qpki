{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/remiblancher/post-quantum-pki/schemas/profile",
  "title": "QPKI Certificate Profile Schema",
  "description": "JSON Schema for QPKI certificate profile YAML files. Derived from internal/profile/*.go types.",
  "type": "object",
  "required": ["name"],
  "properties": {
    "name": {
      "type": "string",
      "pattern": "^[a-z0-9-]+/[a-z0-9-]+$",
      "description": "Unique profile identifier in format 'category/name' (e.g., 'ml/root-ca')"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the profile"
    },
    "mode": {
      "$ref": "#/$defs/mode",
      "description": "Certificate mode: simple (single algo), catalyst (dual-key ITU-T X.509 9.8), or composite (IETF draft-13)"
    },
    "algorithm": {
      "$ref": "#/$defs/algorithmId",
      "description": "Single algorithm for simple mode"
    },
    "algorithms": {
      "type": "array",
      "items": { "$ref": "#/$defs/algorithmId" },
      "minItems": 2,
      "maxItems": 2,
      "description": "Two algorithms for catalyst/composite mode: [classical, PQC]"
    },
    "validity": {
      "$ref": "#/$defs/duration",
      "description": "Certificate validity period (e.g., '365d', '1y', '825d')"
    },
    "subject": {
      "$ref": "#/$defs/subjectConfig",
      "description": "Subject DN configuration"
    },
    "variables": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/variable" },
      "description": "Declarative input variables for template substitution"
    },
    "extensions": {
      "$ref": "#/$defs/extensionsConfig",
      "description": "X.509 extensions configuration"
    },
    "signature": {
      "$ref": "#/$defs/signatureAlgoConfig",
      "description": "Optional signature algorithm override"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "mode": { "const": "simple" } }
      },
      "then": {
        "anyOf": [
          { "required": ["algorithm"] },
          { "required": ["algorithms"] }
        ]
      }
    },
    {
      "if": {
        "properties": { "mode": { "enum": ["catalyst", "composite"] } }
      },
      "then": {
        "required": ["algorithms"]
      }
    }
  ],
  "$defs": {
    "mode": {
      "type": "string",
      "enum": ["simple", "catalyst", "composite"],
      "default": "simple"
    },
    "algorithmId": {
      "type": "string",
      "enum": [
        "ecdsa-p256", "ecdsa-p384", "ecdsa-p521",
        "ed25519", "ed448",
        "rsa-2048", "rsa-4096",
        "ml-dsa-44", "ml-dsa-65", "ml-dsa-87",
        "slh-dsa-128f", "slh-dsa-128s", "slh-dsa-192f", "slh-dsa-192s", "slh-dsa-256f", "slh-dsa-256s",
        "ml-kem-512", "ml-kem-768", "ml-kem-1024"
      ],
      "description": "Cryptographic algorithm identifier"
    },
    "duration": {
      "type": "string",
      "pattern": "^(\\d+y)?(\\d+w)?(\\d+d)?(\\d+h)?(\\d+m)?(\\d+s)?$|^\\{\\{\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\}\\}$",
      "description": "Duration: Go format (1h30m) plus d (days), w (weeks), y (years), or template variable"
    },
    "subjectConfig": {
      "type": "object",
      "properties": {
        "cn": { "$ref": "#/$defs/subjectAttribute" },
        "o": { "$ref": "#/$defs/subjectAttribute" },
        "ou": { "$ref": "#/$defs/subjectAttribute" },
        "c": { "$ref": "#/$defs/subjectAttribute" },
        "st": { "$ref": "#/$defs/subjectAttribute" },
        "l": { "$ref": "#/$defs/subjectAttribute" },
        "street": { "$ref": "#/$defs/subjectAttribute" },
        "postalCode": { "$ref": "#/$defs/subjectAttribute" },
        "serialNumber": { "$ref": "#/$defs/subjectAttribute" },
        "email": { "$ref": "#/$defs/subjectAttribute" }
      },
      "additionalProperties": false
    },
    "subjectAttribute": {
      "oneOf": [
        { "type": "string", "description": "Simple value or template {{ variable }}" },
        {
          "type": "object",
          "properties": {
            "value": { "type": "string" },
            "encoding": {
              "type": "string",
              "enum": ["utf8", "printable", "ia5"],
              "default": "utf8"
            }
          },
          "required": ["value"]
        }
      ]
    },
    "variable": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "$ref": "#/$defs/variableType" },
        "required": { "type": "boolean", "default": false },
        "default": { "description": "Default value (type depends on variable type)" },
        "description": { "type": "string" },
        "pattern": { "type": "string", "format": "regex", "description": "Regex pattern for string validation" },
        "enum": { "type": "array", "items": { "type": "string" }, "description": "Allowed values" },
        "minLength": { "type": "integer", "minimum": 0 },
        "maxLength": { "type": "integer", "minimum": 0 },
        "min": { "type": "integer", "description": "Minimum value for integer" },
        "max": { "type": "integer", "description": "Maximum value for integer" },
        "constraints": { "$ref": "#/$defs/listConstraints" },
        "wildcard": { "$ref": "#/$defs/wildcardPolicy" },
        "allow_single_label": { "type": "boolean", "default": false },
        "min_duration": { "$ref": "#/$defs/duration" },
        "max_duration": { "$ref": "#/$defs/duration" }
      }
    },
    "variableType": {
      "type": "string",
      "enum": ["string", "integer", "boolean", "list", "ip_list", "dns_name", "dns_names", "email", "uri", "oid", "duration"]
    },
    "listConstraints": {
      "type": "object",
      "properties": {
        "allowed_suffixes": { "type": "array", "items": { "type": "string" } },
        "denied_prefixes": { "type": "array", "items": { "type": "string" } },
        "allowed_ranges": { "type": "array", "items": { "type": "string" }, "description": "CIDR ranges for ip_list" },
        "min_items": { "type": "integer", "minimum": 0 },
        "max_items": { "type": "integer", "minimum": 0 },
        "allowed_schemes": { "type": "array", "items": { "type": "string" }, "description": "URI schemes" },
        "allowed_hosts": { "type": "array", "items": { "type": "string" }, "description": "URI hosts" }
      }
    },
    "wildcardPolicy": {
      "type": "object",
      "properties": {
        "allowed": { "type": "boolean", "default": false },
        "single_label": { "type": "boolean", "default": true, "description": "RFC 6125: * matches exactly one label" },
        "forbid_public_suffix": { "type": "boolean", "default": false, "description": "Block wildcards on public suffixes" }
      }
    },
    "extensionsConfig": {
      "type": "object",
      "properties": {
        "keyUsage": { "$ref": "#/$defs/keyUsageConfig" },
        "extKeyUsage": { "$ref": "#/$defs/extKeyUsageConfig" },
        "basicConstraints": { "$ref": "#/$defs/basicConstraintsConfig" },
        "subjectAltName": { "$ref": "#/$defs/subjectAltNameConfig" },
        "crlDistributionPoints": { "$ref": "#/$defs/crlDistributionPointsConfig" },
        "authorityInfoAccess": { "$ref": "#/$defs/authorityInfoAccessConfig" },
        "certificatePolicies": { "$ref": "#/$defs/certificatePoliciesConfig" },
        "nameConstraints": { "$ref": "#/$defs/nameConstraintsConfig" },
        "ocspNoCheck": { "$ref": "#/$defs/ocspNoCheckConfig" },
        "qcStatements": { "$ref": "#/$defs/qcStatementsConfig" },
        "custom": {
          "type": "array",
          "items": { "$ref": "#/$defs/customExtensionConfig" }
        }
      }
    },
    "keyUsageConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": true, "description": "RFC 5280: MUST be critical" },
        "values": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "digitalSignature", "digital-signature",
              "contentCommitment", "content-commitment", "nonRepudiation", "non-repudiation",
              "keyEncipherment", "key-encipherment",
              "dataEncipherment", "data-encipherment",
              "keyAgreement", "key-agreement",
              "certSign", "cert-sign", "keyCertSign", "key-cert-sign",
              "crlSign", "crl-sign",
              "encipherOnly", "encipher-only",
              "decipherOnly", "decipher-only"
            ]
          }
        }
      },
      "required": ["values"]
    },
    "extKeyUsageConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": false },
        "values": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Predefined names (serverAuth, clientAuth, etc.) or OIDs in dot notation"
        }
      },
      "required": ["values"]
    },
    "basicConstraintsConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": true, "description": "RFC 5280: MUST be critical" },
        "ca": { "type": "boolean" },
        "pathLen": { "type": "integer", "minimum": 0 }
      },
      "required": ["ca"]
    },
    "subjectAltNameConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": false, "description": "MUST be critical if subject is empty" },
        "dns": { "$ref": "#/$defs/stringOrSlice" },
        "email": { "$ref": "#/$defs/stringOrSlice" },
        "ip": { "$ref": "#/$defs/stringOrSlice" },
        "uri": { "$ref": "#/$defs/stringOrSlice" },
        "dns_include_cn": { "type": "boolean", "default": false, "description": "Auto-add CN to DNS SANs" }
      }
    },
    "stringOrSlice": {
      "oneOf": [
        { "type": "string" },
        { "type": "array", "items": { "type": "string" } }
      ]
    },
    "crlDistributionPointsConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": false },
        "urls": { "type": "array", "items": { "type": "string", "format": "uri" } }
      },
      "required": ["urls"]
    },
    "authorityInfoAccessConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": false, "description": "RFC 5280: MUST be non-critical" },
        "ocsp": { "type": "array", "items": { "type": "string", "format": "uri" } },
        "caIssuers": { "type": "array", "items": { "type": "string", "format": "uri" } }
      }
    },
    "certificatePoliciesConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": false },
        "policies": {
          "type": "array",
          "items": { "$ref": "#/$defs/policyConfig" }
        }
      },
      "required": ["policies"]
    },
    "policyConfig": {
      "type": "object",
      "properties": {
        "oid": { "type": "string", "pattern": "^\\d+(\\.\\d+)+$" },
        "cps": { "type": "string", "format": "uri" },
        "userNotice": { "type": "string" }
      },
      "required": ["oid"]
    },
    "nameConstraintsConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": true, "description": "RFC 5280: MUST be critical" },
        "permitted": { "$ref": "#/$defs/nameConstraintsSubtrees" },
        "excluded": { "$ref": "#/$defs/nameConstraintsSubtrees" }
      }
    },
    "nameConstraintsSubtrees": {
      "type": "object",
      "properties": {
        "dns": { "type": "array", "items": { "type": "string" } },
        "email": { "type": "array", "items": { "type": "string" } },
        "ip": { "type": "array", "items": { "type": "string" }, "description": "CIDR notation" }
      }
    },
    "ocspNoCheckConfig": {
      "type": "object",
      "properties": {
        "critical": { "type": "boolean", "default": false, "description": "RFC 6960" }
      }
    },
    "qcStatementsConfig": {
      "type": "object",
      "description": "ETSI EN 319 412-5 QCStatements for eIDAS qualified certificates",
      "properties": {
        "critical": { "type": "boolean", "default": false },
        "qcCompliance": { "type": "boolean", "description": "OID 0.4.0.1862.1.1 - EU qualified cert" },
        "qcType": { "type": "string", "enum": ["esign", "eseal", "web"] },
        "qcSSCD": { "type": "boolean", "description": "OID 0.4.0.1862.1.4 - QSCD usage" },
        "qcRetentionPeriod": { "type": "integer", "minimum": 0, "description": "Years" },
        "qcPDS": {
          "type": "array",
          "items": { "$ref": "#/$defs/pdsLocationConfig" }
        }
      }
    },
    "pdsLocationConfig": {
      "type": "object",
      "properties": {
        "url": { "type": "string", "format": "uri" },
        "language": { "type": "string", "pattern": "^[a-z]{2}$", "description": "ISO 639-1" }
      },
      "required": ["url", "language"]
    },
    "customExtensionConfig": {
      "type": "object",
      "properties": {
        "oid": { "type": "string", "pattern": "^\\d+(\\.\\d+)+$" },
        "critical": { "type": "boolean", "default": false },
        "value_hex": { "type": "string", "pattern": "^[0-9a-fA-F]*$" },
        "value_base64": { "type": "string" }
      },
      "required": ["oid"],
      "not": {
        "required": ["value_hex", "value_base64"]
      }
    },
    "signatureAlgoConfig": {
      "type": "object",
      "properties": {
        "hash": {
          "type": "string",
          "enum": ["sha256", "sha384", "sha512"],
          "description": "Hash algorithm for signature"
        }
      }
    }
  }
}
