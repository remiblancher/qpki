name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Show coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "Total coverage: ${COVERAGE}"

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below 60% minimum threshold"
            exit 1
          fi

      - name: Upload coverage to Codecov
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Build binary
        run: go build -o qpki ./cmd/qpki

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: qpki-ci-binary
          path: qpki
          retention-days: 1

      - name: Smoke test
        run: |
          ./qpki --help
          ./qpki ca init --name "Test CA" --profile ec/root-ca --dir /tmp/test-ca
          ./qpki credential enroll --ca-dir /tmp/test-ca --profile ec/tls-server \
            --var cn=test.local --var dns_names=test.local
          ./qpki credential list --ca-dir /tmp/test-ca
          ./qpki cert list --ca-dir /tmp/test-ca

      - name: Smoke test subordinate CA
        run: |
          ./qpki ca init --name "Issuing CA" --profile ec/issuing-ca --dir /tmp/issuing-ca --parent /tmp/test-ca
          ./qpki credential enroll --ca-dir /tmp/issuing-ca --profile ec/tls-server \
            --var cn=sub.test.local --var dns_names=sub.test.local
          ./qpki cert list --ca-dir /tmp/issuing-ca

      - name: Certificate verification
        run: |
          ./qpki inspect /tmp/test-ca/ca.crt
          # Verify subordinate CA chain
          ./qpki verify --cert /tmp/issuing-ca/ca.crt --ca /tmp/test-ca/ca.crt
          # Verify a credential certificate (find first credential)
          CRED_DIR=$(ls -d /tmp/test-ca/credentials/*/ | head -1)
          ./qpki inspect "${CRED_DIR}certificates.pem"
          ./qpki verify --cert "${CRED_DIR}certificates.pem" --ca /tmp/test-ca/ca.crt

      - name: PQC smoke test (ML-DSA-87)
        run: |
          # Create PQC CA
          ./qpki ca init --name "PQC Test CA" --profile ml/root-ca --dir /tmp/pqc-ca
          # Issue PQC certificate using credential enroll
          ./qpki credential enroll --ca-dir /tmp/pqc-ca --profile ml/tls-server-sign \
            --var cn=pqc.test.local --var dns_names=pqc.test.local
          # Get credential certificate path
          PQC_CRED=$(ls -d /tmp/pqc-ca/credentials/*/ | head -1)
          # Verify with qpki tool (OpenSSL doesn't support PQC yet)
          ./qpki verify --cert "${PQC_CRED}certificates.pem" --ca /tmp/pqc-ca/ca.crt
          ./qpki inspect "${PQC_CRED}certificates.pem"

      - name: PQC smoke test (SLH-DSA-256f)
        run: |
          # Create SLH-DSA CA
          ./qpki ca init --name "SLH-DSA Test CA" --profile slh/root-ca --dir /tmp/slhdsa-ca
          # Issue SLH-DSA certificate using credential enroll
          ./qpki credential enroll --ca-dir /tmp/slhdsa-ca --profile slh/tls-server \
            --var cn=slhdsa.test.local --var dns_names=slhdsa.test.local
          # Get credential certificate path
          SLHDSA_CRED=$(ls -d /tmp/slhdsa-ca/credentials/*/ | head -1)
          # Verify with qpki tool
          ./qpki verify --cert "${SLHDSA_CRED}certificates.pem" --ca /tmp/slhdsa-ca/ca.crt
          ./qpki inspect "${SLHDSA_CRED}certificates.pem"

      - name: Catalyst hybrid smoke test (ECDSA + ML-DSA)
        run: |
          # Create Catalyst hybrid CA
          ./qpki ca init --name "Catalyst Test CA" --dir /tmp/catalyst-ca \
            --profile hybrid/catalyst/root-ca
          # Issue Catalyst certificate with dual signatures using credential enroll
          ./qpki credential enroll --ca-dir /tmp/catalyst-ca --profile hybrid/catalyst/tls-server \
            --var cn=catalyst.test.local --var dns_names=catalyst.test.local
          # Get credential certificate path
          CATALYST_CRED=$(ls -d /tmp/catalyst-ca/credentials/*/ | head -1)
          # Verify both signatures with qpki tool
          ./qpki verify --cert "${CATALYST_CRED}certificates.pem" --ca /tmp/catalyst-ca/ca.crt
          # Show certificate with Catalyst extensions
          ./qpki inspect "${CATALYST_CRED}certificates.pem"

      - name: Composite hybrid smoke test (IETF ECDSA + ML-DSA)
        run: |
          # Create Composite hybrid CA (IETF draft-ietf-lamps-pq-composite-sigs-13)
          ./qpki ca init --name "Composite Test CA" --dir /tmp/composite-ca \
            --profile hybrid/composite/root-ca
          # Issue Composite certificate with single composite signature
          ./qpki credential enroll --ca-dir /tmp/composite-ca --profile hybrid/composite/tls-server \
            --var cn=composite.test.local --var dns_names=composite.test.local
          # Get credential certificate path
          COMPOSITE_CRED=$(ls -d /tmp/composite-ca/credentials/*/ | head -1)
          # Verify both component signatures with qpki tool
          ./qpki verify --cert "${COMPOSITE_CRED}certificates.pem" --ca /tmp/composite-ca/ca.crt
          # Show certificate info
          ./qpki inspect "${COMPOSITE_CRED}certificates.pem"
          ./qpki inspect /tmp/composite-ca/ca.crt

  pki-test:
    name: PKI Functional Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      # Key generation tests
      - name: "key gen: EC algorithms"
        run: |
          mkdir -p /tmp/keys
          ./qpki key gen --algorithm ecdsa-p256 -o /tmp/keys/ec-p256.key
          ./qpki key gen --algorithm ecdsa-p384 -o /tmp/keys/ec-p384.key
          ./qpki key gen --algorithm ecdsa-p521 -o /tmp/keys/ec-p521.key

      - name: "key gen: RSA algorithms"
        run: |
          ./qpki key gen --algorithm rsa-2048 -o /tmp/keys/rsa-2048.key
          ./qpki key gen --algorithm rsa-4096 -o /tmp/keys/rsa-4096.key

      - name: "key gen: ML-DSA (PQC)"
        run: |
          ./qpki key gen --algorithm ml-dsa-44 -o /tmp/keys/ml-dsa-44.key
          ./qpki key gen --algorithm ml-dsa-65 -o /tmp/keys/ml-dsa-65.key
          ./qpki key gen --algorithm ml-dsa-87 -o /tmp/keys/ml-dsa-87.key

      - name: "key gen: SLH-DSA (PQC)"
        run: |
          ./qpki key gen --algorithm slh-dsa-128f -o /tmp/keys/slh-dsa-128f.key
          ./qpki key gen --algorithm slh-dsa-192f -o /tmp/keys/slh-dsa-192f.key

      # Key info tests
      - name: "key info: various algorithms"
        run: |
          ./qpki key info /tmp/keys/ec-p384.key
          ./qpki key info /tmp/keys/rsa-4096.key
          ./qpki key info /tmp/keys/ml-dsa-65.key

      # Key list tests (directory mode)
      - name: "key list: directory mode"
        run: |
          ./qpki key list --dir /tmp/keys
          # Verify output shows keys
          ./qpki key list --dir /tmp/keys | grep -q "ec-p256.key" || (echo "FAIL: ec-p256 not listed" && exit 1)
          ./qpki key list --dir /tmp/keys | grep -q "ml-dsa-65.key" || (echo "FAIL: ml-dsa-65 not listed" && exit 1)

      # Note: key list --hsm-config is tested in hsm-test job

      # CSR tests
      - name: "cert csr: EC"
        run: |
          ./qpki cert csr --key /tmp/keys/ec-p384.key \
            --cn "ec-csr-test.local" \
            -o /tmp/csr-ec.pem
          test -f /tmp/csr-ec.pem

      - name: "cert csr: RSA"
        run: |
          ./qpki cert csr --key /tmp/keys/rsa-4096.key \
            --cn "rsa-csr-test.local" \
            -o /tmp/csr-rsa.pem
          test -f /tmp/csr-rsa.pem

      # Note: ML-DSA direct CSR not supported (Go x509 limitation) - use credential enroll instead

      - name: "cert csr: ML-KEM with ML-DSA attestation (RFC 9883)"
        run: |
          # Create ML-DSA CA for attestation certificates
          ./qpki ca init --name "Attestation CA" --profile ml/root-ca --dir /tmp/ca-attest
          # Issue ML-DSA signing credential for attestation
          ./qpki credential enroll --ca-dir /tmp/ca-attest --profile ml/signing \
            --var cn="Attestation Signer"
          ATTEST_CRED=$(ls -d /tmp/ca-attest/credentials/*/)
          # Create ML-KEM CSR with ML-DSA attestation (RFC 9883)
          ./qpki cert csr --algorithm ml-kem-768 \
            --keyout /tmp/keys/mlkem.key \
            --attest-cert "${ATTEST_CRED}certificates.pem" \
            --attest-key "${ATTEST_CRED}private-keys.pem" \
            --cn "mlkem-test.local" \
            -o /tmp/csr-mlkem.pem
          test -f /tmp/csr-mlkem.pem && test -f /tmp/keys/mlkem.key

      # CA init tests
      - name: "ca init: EC profile"
        run: |
          ./qpki ca init --name "EC Root CA" --profile ec/root-ca --dir /tmp/ca-ec
          test -f /tmp/ca-ec/ca.crt
          test -f /tmp/ca-ec/ca.meta.json

      - name: "ca init: RSA profile"
        run: |
          ./qpki ca init --name "RSA Root CA" --profile rsa/root-ca --dir /tmp/ca-rsa
          test -f /tmp/ca-rsa/ca.crt

      - name: "ca init: ML-DSA profile"
        run: |
          ./qpki ca init --name "ML-DSA Root CA" --profile ml/root-ca --dir /tmp/ca-mldsa
          test -f /tmp/ca-mldsa/ca.crt

      - name: "ca init: Catalyst hybrid"
        run: |
          ./qpki ca init --name "Catalyst Root CA" --profile hybrid/catalyst/root-ca --dir /tmp/ca-catalyst
          test -f /tmp/ca-catalyst/ca.crt

      - name: "ca init: Composite hybrid"
        run: |
          ./qpki ca init --name "Composite Root CA" --profile hybrid/composite/root-ca --dir /tmp/ca-composite
          test -f /tmp/ca-composite/ca.crt

      - name: "ca init: SLH-DSA profile"
        run: |
          ./qpki ca init --name "SLH-DSA Root CA" --profile slh/root-ca --dir /tmp/ca-slhdsa
          test -f /tmp/ca-slhdsa/ca.crt

      - name: "ca init: Issuing CA (subordinate)"
        run: |
          ./qpki ca init --name "Issuing CA" --profile ec/issuing-ca \
            --dir /tmp/ca-issuing --parent /tmp/ca-ec
          test -f /tmp/ca-issuing/ca.crt

      # CA info tests
      - name: "ca info: various CAs"
        run: |
          ./qpki ca info --ca-dir /tmp/ca-ec
          ./qpki ca info --ca-dir /tmp/ca-rsa
          ./qpki ca info --ca-dir /tmp/ca-mldsa
          ./qpki ca info --ca-dir /tmp/ca-slhdsa
          ./qpki ca info --ca-dir /tmp/ca-catalyst
          ./qpki ca info --ca-dir /tmp/ca-composite

      # Certificate issue via CSR
      - name: "cert issue: EC from CSR"
        run: |
          ./qpki cert issue --ca-dir /tmp/ca-ec \
            --csr /tmp/csr-ec.pem \
            --profile ec/tls-server \
            -o /tmp/issued-ec.crt
          test -f /tmp/issued-ec.crt

      - name: "cert issue: RSA from CSR"
        run: |
          ./qpki cert issue --ca-dir /tmp/ca-rsa \
            --csr /tmp/csr-rsa.pem \
            --profile rsa/tls-server \
            -o /tmp/issued-rsa.crt
          test -f /tmp/issued-rsa.crt

      # Note: ML-DSA cert issue from CSR not supported - use credential enroll instead

      # Credential enroll tests
      - name: "credential enroll: EC"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-ec \
            --profile ec/tls-server \
            --var cn=ec.test.local --var dns_names=ec.test.local

      - name: "credential enroll: RSA"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-rsa \
            --profile rsa/tls-server \
            --var cn=rsa.test.local --var dns_names=rsa.test.local

      - name: "credential enroll: ML-DSA"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-mldsa \
            --profile ml/tls-server-sign \
            --var cn=mldsa.test.local --var dns_names=mldsa.test.local

      - name: "credential enroll: Catalyst"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-catalyst \
            --profile hybrid/catalyst/tls-server \
            --var cn=catalyst.test.local --var dns_names=catalyst.test.local

      - name: "credential enroll: Composite"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-composite \
            --profile hybrid/composite/tls-server \
            --var cn=composite.test.local --var dns_names=composite.test.local

      - name: "credential enroll: SLH-DSA"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-slhdsa \
            --profile slh/tls-server \
            --var cn=slhdsa.test.local --var dns_names=slhdsa.test.local

      # Additional credential profiles per CA type
      - name: "credential enroll: EC profiles"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-ec --profile ec/ocsp-responder \
            --var cn="EC OCSP Responder"
          ./qpki credential enroll --ca-dir /tmp/ca-ec --profile ec/timestamping \
            --var cn="EC TSA"
          ./qpki credential enroll --ca-dir /tmp/ca-ec --profile ec/code-signing \
            --var cn="EC Code Signer"
          ./qpki credential enroll --ca-dir /tmp/ca-ec --profile ec/email \
            --var cn="ec-user@test.local" --var email=ec-user@test.local
          ./qpki credential enroll --ca-dir /tmp/ca-ec --profile ec/signing \
            --var cn="EC Signer"

      - name: "credential enroll: RSA profiles"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-rsa --profile rsa/timestamping \
            --var cn="RSA TSA"
          ./qpki credential enroll --ca-dir /tmp/ca-rsa --profile rsa/code-signing \
            --var cn="RSA Code Signer"
          ./qpki credential enroll --ca-dir /tmp/ca-rsa --profile rsa/email \
            --var cn="rsa-user@test.local" --var email=rsa-user@test.local
          ./qpki credential enroll --ca-dir /tmp/ca-rsa --profile rsa/encryption \
            --var cn="RSA Encryption"
          ./qpki credential enroll --ca-dir /tmp/ca-rsa --profile rsa/signing \
            --var cn="RSA Signer"

      - name: "credential enroll: ML-DSA profiles"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-mldsa --profile ml/ocsp-responder \
            --var cn="ML-DSA OCSP Responder"
          ./qpki credential enroll --ca-dir /tmp/ca-mldsa --profile ml/timestamping \
            --var cn="ML-DSA TSA"
          ./qpki credential enroll --ca-dir /tmp/ca-mldsa --profile ml/code-signing \
            --var cn="ML-DSA Code Signer"
          ./qpki credential enroll --ca-dir /tmp/ca-mldsa --profile ml/email-sign \
            --var cn="mldsa-user@test.local" --var email=mldsa-user@test.local
          ./qpki credential enroll --ca-dir /tmp/ca-mldsa --profile ml/signing \
            --var cn="ML-DSA Signer"

      - name: "credential enroll: SLH-DSA profiles"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-slhdsa --profile slh/timestamping \
            --var cn="SLH-DSA TSA"
          ./qpki credential enroll --ca-dir /tmp/ca-slhdsa --profile slh/tls-client \
            --var cn="slhdsa-client.test.local"

      - name: "credential enroll: Catalyst profiles"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-catalyst --profile hybrid/catalyst/ocsp-responder \
            --var cn="Catalyst OCSP Responder"
          ./qpki credential enroll --ca-dir /tmp/ca-catalyst --profile hybrid/catalyst/timestamping \
            --var cn="Catalyst TSA"
          ./qpki credential enroll --ca-dir /tmp/ca-catalyst --profile hybrid/catalyst/signing \
            --var cn="Catalyst Signer"

      - name: "credential enroll: Composite profiles"
        run: |
          ./qpki credential enroll --ca-dir /tmp/ca-composite --profile hybrid/composite/timestamping \
            --var cn="Composite TSA"
          ./qpki credential enroll --ca-dir /tmp/ca-composite --profile hybrid/composite/tls-client \
            --var cn="composite-client.test.local"

      # Credential list tests
      - name: "credential list: various CAs"
        run: |
          ./qpki credential list --ca-dir /tmp/ca-ec
          ./qpki credential list --ca-dir /tmp/ca-rsa
          ./qpki credential list --ca-dir /tmp/ca-mldsa
          ./qpki credential list --ca-dir /tmp/ca-slhdsa
          ./qpki credential list --ca-dir /tmp/ca-catalyst
          ./qpki credential list --ca-dir /tmp/ca-composite

      # Certificate list tests
      - name: "cert list: various CAs"
        run: |
          ./qpki cert list --ca-dir /tmp/ca-ec
          ./qpki cert list --ca-dir /tmp/ca-rsa
          ./qpki cert list --ca-dir /tmp/ca-mldsa
          ./qpki cert list --ca-dir /tmp/ca-slhdsa
          ./qpki cert list --ca-dir /tmp/ca-catalyst
          ./qpki cert list --ca-dir /tmp/ca-composite

      # CRL generation
      - name: "ca crl gen: EC CA"
        run: |
          ./qpki ca crl gen --ca-dir /tmp/ca-ec
          test -f /tmp/ca-ec/crl/ca.crl

      - name: "ca crl gen: RSA CA"
        run: |
          ./qpki ca crl gen --ca-dir /tmp/ca-rsa
          test -f /tmp/ca-rsa/crl/ca.crl

      - name: "ca crl gen: ML-DSA CA"
        run: |
          ./qpki ca crl gen --ca-dir /tmp/ca-mldsa
          test -f /tmp/ca-mldsa/crl/ca.crl

      - name: "ca crl gen: Catalyst CA"
        run: |
          ./qpki ca crl gen --ca-dir /tmp/ca-catalyst
          test -f /tmp/ca-catalyst/crl/ca.crl

      - name: "ca crl gen: Composite CA"
        run: |
          ./qpki ca crl gen --ca-dir /tmp/ca-composite
          test -f /tmp/ca-composite/crl/ca.crl

      - name: "ca crl gen: SLH-DSA CA"
        run: |
          ./qpki ca crl gen --ca-dir /tmp/ca-slhdsa
          test -f /tmp/ca-slhdsa/crl/ca.crl

      # Verify tests
      - name: "verify: EC certificate"
        run: |
          EC_CRED=$(ls -d /tmp/ca-ec/credentials/*/ | head -1)
          ./qpki verify --cert "${EC_CRED}certificates.pem" --ca /tmp/ca-ec/ca.crt

      - name: "verify: RSA certificate"
        run: |
          RSA_CRED=$(ls -d /tmp/ca-rsa/credentials/*/ | head -1)
          ./qpki verify --cert "${RSA_CRED}certificates.pem" --ca /tmp/ca-rsa/ca.crt

      - name: "verify: ML-DSA certificate"
        run: |
          MLDSA_CRED=$(ls -d /tmp/ca-mldsa/credentials/*/ | head -1)
          ./qpki verify --cert "${MLDSA_CRED}certificates.pem" --ca /tmp/ca-mldsa/ca.crt

      - name: "verify: Catalyst certificate"
        run: |
          CATALYST_CRED=$(ls -d /tmp/ca-catalyst/credentials/*/ | head -1)
          ./qpki verify --cert "${CATALYST_CRED}certificates.pem" --ca /tmp/ca-catalyst/ca.crt

      - name: "verify: Composite certificate"
        run: |
          COMPOSITE_CRED=$(ls -d /tmp/ca-composite/credentials/*/ | head -1)
          ./qpki verify --cert "${COMPOSITE_CRED}certificates.pem" --ca /tmp/ca-composite/ca.crt

      - name: "verify: SLH-DSA certificate"
        run: |
          SLHDSA_CRED=$(ls -d /tmp/ca-slhdsa/credentials/*/ | head -1)
          ./qpki verify --cert "${SLHDSA_CRED}certificates.pem" --ca /tmp/ca-slhdsa/ca.crt

      # Inspect tests
      - name: "inspect: various certificates"
        run: |
          ./qpki inspect /tmp/ca-ec/ca.crt
          ./qpki inspect /tmp/ca-rsa/ca.crt
          ./qpki inspect /tmp/ca-mldsa/ca.crt
          ./qpki inspect /tmp/ca-slhdsa/ca.crt
          ./qpki inspect /tmp/ca-catalyst/ca.crt
          ./qpki inspect /tmp/ca-composite/ca.crt

      # Revocation tests
      - name: "credential revoke + cert revoke"
        run: |
          # Get first EC credential
          EC_CRED_DIR=$(ls -d /tmp/ca-ec/credentials/*/ | head -1)
          EC_CRED_ID=$(basename "$EC_CRED_DIR")
          # Revoke credential
          ./qpki credential revoke "$EC_CRED_ID" --ca-dir /tmp/ca-ec --reason key_compromise
          # Verify CRL is updated
          ./qpki ca crl gen --ca-dir /tmp/ca-ec
          # Check revocation status
          ./qpki cert list --ca-dir /tmp/ca-ec | grep -i revoked

      # CA metadata verification
      - name: "ca.meta.json: structure verification"
        run: |
          # Verify EC CA metadata
          cat /tmp/ca-ec/ca.meta.json
          grep -q '"profile"' /tmp/ca-ec/ca.meta.json
          grep -q '"keys"' /tmp/ca-ec/ca.meta.json
          # Verify Hybrid CA metadata
          cat /tmp/ca-catalyst/ca.meta.json

      # Credential metadata verification
      - name: "credential.meta.json: structure verification"
        run: |
          EC_CRED=$(ls -d /tmp/ca-ec/credentials/*/ | tail -1)
          cat "${EC_CRED}credential.meta.json"

  ocsp-test:
    name: OCSP Functional Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      - name: Setup CA and certificates
        run: |
          # Create CA
          ./qpki ca init --name "OCSP Test CA" --profile ec/root-ca --dir /tmp/ocsp-ca
          # Issue OCSP responder certificate
          ./qpki credential enroll --ca-dir /tmp/ocsp-ca --profile ec/ocsp-responder \
            --var cn="OCSP Responder"
          # Issue end-entity certificate to query
          ./qpki credential enroll --ca-dir /tmp/ocsp-ca --profile ec/tls-server \
            --var cn=test.local --var dns_names=test.local
          # Get paths (OCSP responder created first = oldest, EE cert created second = newest)
          OCSP_CRED=$(ls -dt /tmp/ocsp-ca/credentials/*/ | tail -1)
          EE_CRED=$(ls -dt /tmp/ocsp-ca/credentials/*/ | head -1)
          echo "OCSP_CRED=$OCSP_CRED" >> $GITHUB_ENV
          echo "EE_CRED=$EE_CRED" >> $GITHUB_ENV

      - name: Test OCSP request command
        run: |
          ./qpki ocsp request \
            --issuer /tmp/ocsp-ca/ca.crt \
            --cert "${EE_CRED}certificates.pem" \
            -o /tmp/ocsp-req.der
          test -f /tmp/ocsp-req.der || (echo "OCSP request not created" && exit 1)

      - name: Test OCSP sign command
        run: |
          # Get the serial number from the CA index (EE cert is the last one issued)
          # Index format is tab-separated: status, expiry, revocation, serial, filename, subject
          SERIAL=$(tail -1 /tmp/ocsp-ca/index.txt | awk -F'\t' '{print $4}')
          # Sign OCSP response
          ./qpki ocsp sign \
            --serial "$SERIAL" \
            --status good \
            --ca /tmp/ocsp-ca/ca.crt \
            --cert "${OCSP_CRED}certificates.pem" \
            --key "${OCSP_CRED}private-keys.pem" \
            -o /tmp/ocsp-resp.der
          test -f /tmp/ocsp-resp.der || (echo "OCSP response not created" && exit 1)

      - name: Test OCSP verify command
        run: |
          ./qpki ocsp verify \
            --response /tmp/ocsp-resp.der \
            --ca /tmp/ocsp-ca/ca.crt

      - name: Test OCSP info command
        run: |
          ./qpki ocsp info /tmp/ocsp-resp.der

      - name: Test OCSP serve command
        run: |
          # Start OCSP server in background
          ./qpki ocsp serve \
            --port 8888 \
            --ca-dir /tmp/ocsp-ca \
            --cert "${OCSP_CRED}certificates.pem" \
            --key "${OCSP_CRED}private-keys.pem" &
          OCSP_PID=$!
          sleep 2
          # Create OCSP request
          ./qpki ocsp request \
            --issuer /tmp/ocsp-ca/ca.crt \
            --cert "${EE_CRED}certificates.pem" \
            -o /tmp/ocsp-query.der
          # Query OCSP server with curl
          curl -s -X POST \
            -H "Content-Type: application/ocsp-request" \
            --data-binary @/tmp/ocsp-query.der \
            -o /tmp/ocsp-server-resp.der \
            http://localhost:8888 || (kill $OCSP_PID 2>/dev/null; exit 1)
          # Verify response with qpki
          ./qpki ocsp verify \
            --response /tmp/ocsp-server-resp.der \
            --ca /tmp/ocsp-ca/ca.crt || (kill $OCSP_PID 2>/dev/null; exit 1)
          kill $OCSP_PID 2>/dev/null || true

  tsa-test:
    name: TSA Functional Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      - name: Setup CA and TSA certificate
        run: |
          ./qpki ca init --name "TSA Test CA" --profile ec/root-ca --dir /tmp/tsa-ca
          # Issue TSA certificate
          ./qpki credential enroll --ca-dir /tmp/tsa-ca --profile ec/timestamping \
            --var cn="Timestamp Authority"
          TSA_CRED=$(ls -d /tmp/tsa-ca/credentials/*/ | head -1)
          echo "TSA_CRED=$TSA_CRED" >> $GITHUB_ENV

      - name: Test TSA sign command
        run: |
          echo "Test data for timestamping" > /tmp/test-data.txt
          ./qpki tsa sign \
            --data /tmp/test-data.txt \
            --cert "${TSA_CRED}certificates.pem" \
            --key "${TSA_CRED}private-keys.pem" \
            -o /tmp/timestamp.tsr
          test -f /tmp/timestamp.tsr || (echo "Timestamp token not created" && exit 1)

      - name: Test TSA verify command
        run: |
          ./qpki tsa verify \
            --token /tmp/timestamp.tsr \
            --data /tmp/test-data.txt \
            --ca /tmp/tsa-ca/ca.crt

      - name: Test TSA serve command
        run: |
          # Start TSA server in background
          ./qpki tsa serve \
            --port 8889 \
            --cert "${TSA_CRED}certificates.pem" \
            --key "${TSA_CRED}private-keys.pem" &
          TSA_PID=$!
          sleep 2
          # Create timestamp request
          ./qpki tsa request --data /tmp/test-data.txt -o /tmp/ts-req.tsq
          # Query TSA server
          curl -s -H "Content-Type: application/timestamp-query" \
            --data-binary @/tmp/ts-req.tsq \
            http://localhost:8889 -o /tmp/ts-resp.tsr
          # Verify response
          ./qpki tsa verify --token /tmp/ts-resp.tsr --data /tmp/test-data.txt \
            --ca /tmp/tsa-ca/ca.crt || (kill $TSA_PID 2>/dev/null; exit 1)
          kill $TSA_PID 2>/dev/null || true

  cms-test:
    name: CMS Functional Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      - name: Setup CA and certificates
        run: |
          # Create EC CA for signing
          ./qpki ca init --name "CMS Test CA" --profile ec/root-ca --dir /tmp/cms-ca
          # Issue signing certificate (EC) - digitalSignature + nonRepudiation
          ./qpki credential enroll --ca-dir /tmp/cms-ca --profile ec/signing \
            --var cn="CMS Signer"
          EC_CRED=$(ls -d /tmp/cms-ca/credentials/*/ | head -1)
          echo "EC_CRED=$EC_CRED" >> $GITHUB_ENV
          # Create RSA CA for encryption
          ./qpki ca init --name "RSA Test CA" --profile rsa/root-ca --dir /tmp/rsa-ca
          # Issue RSA encryption certificate - keyEncipherment
          ./qpki credential enroll --ca-dir /tmp/rsa-ca --profile rsa/encryption \
            --var cn="CMS Recipient"
          RSA_CRED=$(ls -d /tmp/rsa-ca/credentials/*/ | head -1)
          echo "RSA_CRED=$RSA_CRED" >> $GITHUB_ENV

      - name: Test CMS sign command
        run: |
          echo "Test data for CMS signing" > /tmp/cms-data.txt
          ./qpki cms sign \
            --data /tmp/cms-data.txt \
            --cert "${EC_CRED}certificates.pem" \
            --key "${EC_CRED}private-keys.pem" \
            -o /tmp/signed.p7s
          test -f /tmp/signed.p7s || (echo "Signed data not created" && exit 1)

      - name: Test CMS verify command
        run: |
          ./qpki cms verify \
            --signature /tmp/signed.p7s \
            --data /tmp/cms-data.txt \
            --ca /tmp/cms-ca/ca.crt

      - name: Test CMS encrypt command (RSA)
        run: |
          ./qpki cms encrypt \
            --recipient "${RSA_CRED}certificates.pem" \
            --in /tmp/cms-data.txt \
            --out /tmp/encrypted.p7m
          test -f /tmp/encrypted.p7m || (echo "Encrypted data not created" && exit 1)

      - name: Test CMS decrypt command
        run: |
          ./qpki cms decrypt \
            --key "${RSA_CRED}private-keys.pem" \
            --in /tmp/encrypted.p7m \
            --out /tmp/decrypted.txt
          diff /tmp/cms-data.txt /tmp/decrypted.txt

  crosstest-openssl:
    name: Cross Tests (OpenSSL 3.6)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      - name: Cache OpenSSL 3.6
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: /opt/openssl-3.6
          key: openssl-3.6.0-${{ runner.os }}

      - name: Install OpenSSL 3.6.0
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/openssl/openssl/releases/download/openssl-3.6.0/openssl-3.6.0.tar.gz
          tar xzf openssl-3.6.0.tar.gz && cd openssl-3.6.0
          ./Configure --prefix=/opt/openssl-3.6 --libdir=lib
          make -j$(nproc) && sudo make install

      - name: Configure OpenSSL 3.6 path
        run: |
          echo "/opt/openssl-3.6/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=/opt/openssl-3.6/lib" >> $GITHUB_ENV

      - name: Verify OpenSSL version
        run: |
          /opt/openssl-3.6/bin/openssl version
          /opt/openssl-3.6/bin/openssl version | grep -q "3.6"

      - name: Generate test fixtures
        run: |
          chmod +x test/generate_fixtures.sh
          ./test/generate_fixtures.sh

      - name: Run all OpenSSL cross-tests
        run: |
          cd test/openssl
          chmod +x *.sh
          ./run_all.sh

  crosstest-bc:
    name: Cross Tests (BouncyCastle 1.83)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Generate test fixtures
        run: |
          chmod +x test/generate_fixtures.sh
          ./test/generate_fixtures.sh

      - name: BouncyCastle - All certificates
        run: |
          cd test/bouncycastle
          mvn -q test

  hsm-test:
    name: HSM Tests (SoftHSM2)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install SoftHSM2
        run: sudo apt-get update && sudo apt-get install -y softhsm2

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary

      - name: Make executable
        run: chmod +x ./qpki

      - name: Configure SoftHSM2
        run: |
          mkdir -p ~/.config/softhsm2/tokens
          echo "directories.tokendir = $HOME/.config/softhsm2/tokens" > ~/.config/softhsm2/softhsm2.conf
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf

      - name: Initialize token
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          softhsm2-util --init-token --slot 0 --label "QPKI-Test" --pin 1234 --so-pin 12345678

      - name: Create HSM config
        run: |
          cat > /tmp/hsm-test.yaml << 'EOF'
          type: pkcs11
          pkcs11:
            lib: /usr/lib/softhsm/libsofthsm2.so
            token: "QPKI-Test"
            pin_env: HSM_PIN
          EOF

      - name: Generate EC key in HSM (qpki)
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki key gen --algorithm ecdsa-p384 \
            --hsm-config /tmp/hsm-test.yaml \
            --key-label "test-ca-key"

      - name: Test HSM list command
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          ./qpki hsm list --lib /usr/lib/softhsm/libsofthsm2.so

      - name: Test HSM test command
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki hsm test --hsm-config /tmp/hsm-test.yaml

      - name: Test key list command (HSM)
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki key list --hsm-config /tmp/hsm-test.yaml

      - name: Test key gen command (HSM)
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki key gen --algorithm ecdsa-p384 \
            --hsm-config /tmp/hsm-test.yaml \
            --key-label "generated-key"
          # Verify the key was created
          ./qpki key list --hsm-config /tmp/hsm-test.yaml | grep "generated-key"

      - name: Initialize CA with HSM key
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki ca init --hsm-config /tmp/hsm-test.yaml \
            --key-label "test-ca-key" \
            --profile ec/root-ca \
            --name "HSM Test CA" \
            --dir /tmp/hsm-ca

      - name: Initialize CA with generated HSM key
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki ca init --hsm-config /tmp/hsm-test.yaml \
            --key-label "auto-gen-ca-key" \
            --generate-key \
            --profile ec/root-ca \
            --name "Auto-Gen HSM CA" \
            --dir /tmp/hsm-ca-auto
          # Verify the CA was created
          ./qpki inspect /tmp/hsm-ca-auto/ca.crt | grep "Auto-Gen HSM CA"

      - name: Verify CA certificate
        run: |
          ./qpki inspect /tmp/hsm-ca/ca.crt
          ls -la /tmp/hsm-ca/

      - name: Verify CA metadata (ca.meta.json)
        run: |
          # Verify metadata exists
          test -f /tmp/hsm-ca-auto/ca.meta.json || (echo "ERROR: ca.meta.json not found" && exit 1)
          # Display metadata
          cat /tmp/hsm-ca-auto/ca.meta.json
          # Verify profile field
          grep -q '"profile"' /tmp/hsm-ca-auto/ca.meta.json
          # Verify keys array
          grep -q '"keys"' /tmp/hsm-ca-auto/ca.meta.json
          # Verify storage type is pkcs11 for HSM CA
          grep -q '"type"' /tmp/hsm-ca-auto/ca.meta.json

      - name: Generate RSA key in HSM (qpki)
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki key gen --algorithm rsa-4096 \
            --hsm-config /tmp/hsm-test.yaml \
            --key-label "rsa-test-key"

      - name: Initialize RSA CA with HSM key
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki ca init --hsm-config /tmp/hsm-test.yaml \
            --key-label "rsa-test-key" \
            --profile rsa/root-ca \
            --name "RSA HSM Test CA" \
            --dir /tmp/hsm-ca-rsa

      - name: Verify RSA CA certificate
        run: ./qpki inspect /tmp/hsm-ca-rsa/ca.crt | grep "RSA"

      # Note: credential enroll --hsm-config is not yet implemented
      # See KeyManager refactoring plan for future HSM credential support
      - name: Issue software credential from HSM CA
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki credential enroll --ca-dir /tmp/hsm-ca-auto \
            --profile ec/tls-server \
            --var cn=hsm.test.local \
            --var dns_names=hsm.test.local

      - name: Verify credential metadata (credential.meta.json)
        run: |
          CRED_DIR=$(ls -d /tmp/hsm-ca-auto/credentials/*/ | head -1)
          test -f "${CRED_DIR}credential.meta.json" || (echo "ERROR: credential.meta.json not found" && exit 1)
          cat "${CRED_DIR}credential.meta.json"

      - name: Verify CA info with qpki
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki ca info --ca-dir /tmp/hsm-ca
          ./qpki ca info --ca-dir /tmp/hsm-ca-auto

      - name: List credentials from HSM CA
        run: |
          export SOFTHSM2_CONF=$HOME/.config/softhsm2/softhsm2.conf
          export HSM_PIN=1234
          ./qpki credential list --ca-dir /tmp/hsm-ca-auto

      # Note: HSM-based OCSP/TSA/CMS tests require KeyManager refactoring
      # These tests will be re-enabled once credential enroll --hsm-config is implemented
      # For now, we test HSM CA initialization and software credential issuance

  lab-tests:
    name: Lab Demo Tests (E2E)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Checkout lab repo
        uses: actions/checkout@v4
        with:
          repository: remiblancher/post-quantum-pki-lab
          ref: main
          path: lab
          token: ${{ secrets.LAB_REPO_TOKEN }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: qpki-ci-binary
          path: lab/bin/

      - name: Make executable
        run: |
          chmod +x lab/bin/qpki
          lab/bin/qpki --version

      - name: Run all lab demos
        env:
          CI: "true"
        run: |
          cd lab
          failed=0
          for demo in journey/*/demo.sh; do
            demo_dir=$(dirname "$demo")
            echo ""
            echo "=========================================="
            echo "Testing: $demo"
            echo "=========================================="
            if (cd "$demo_dir" && bash demo.sh); then
              echo "✓ PASSED: $demo"
            else
              echo "✗ FAILED: $demo"
              failed=$((failed + 1))
            fi
          done

          echo ""
          echo "=========================================="
          if [ $failed -eq 0 ]; then
            echo "All lab demos passed!"
          else
            echo "FAILED: $failed demo(s) failed"
            exit 1
          fi

      - name: Upload demo outputs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lab-demo-outputs
          path: lab/journey/*/output/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'

  build-matrix:
    timeout-minutes: 15
    needs: [test, lint]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Build (Unix)
        if: matrix.goos != 'windows'
        env:
          CGO_ENABLED: 1
        run: go build -o qpki-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/qpki

      - name: Build (Windows)
        if: matrix.goos == 'windows'
        env:
          CGO_ENABLED: 1
        run: go build -o qpki-${{ matrix.goos }}-${{ matrix.goarch }}.exe ./cmd/qpki

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qpki-${{ matrix.goos }}-${{ matrix.goarch }}
          path: qpki-*
          retention-days: 7

  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Fuzz CMS parsers
        run: |
          go test -fuzz=FuzzParseSignedData -fuzztime=60s ./internal/cms/ || true
          go test -fuzz=FuzzParseEnvelopedData -fuzztime=60s ./internal/cms/ || true

      - name: Fuzz TSA parsers
        run: |
          go test -fuzz=FuzzParseRequest -fuzztime=60s ./internal/tsa/ || true
          go test -fuzz=FuzzParseResponse -fuzztime=60s ./internal/tsa/ || true

      - name: Fuzz OCSP parsers
        run: |
          go test -fuzz=FuzzParseRequest -fuzztime=60s ./internal/ocsp/ || true
          go test -fuzz=FuzzParseResponse -fuzztime=60s ./internal/ocsp/ || true

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes
          path: |
            **/testdata/fuzz/**/
          retention-days: 30
